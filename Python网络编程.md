

### Http、TCP/UDP、socket
http使用TCP\UDP连接，TCP\UDP是一种协议，其具体实现是socket(操作系统负责底层通信
 
http请求：维护一个线程池，每个线程完成一次请求，当没有空闲线程时就会出现503 service unavailable  
IO多路复用：多个网络连接，复用同一个线程  

TCP/IP协议的操作系统实现：socket  类似于文件操作 listen accept send write
使用端口进行多路复用和分解  使用UDP协议的程序需要自己处理丢包、重组和包的乱序问题--不如使用消息队列
TCP则保证了数据流的顺序和可靠传输
![TCP分层.jpg](https://github.com/yuanlongzeng/my-summary/blob/master/img/TCP%E5%88%86%E5%B1%82.jpg)

其中socke API层之下的几层：  
传输控制协议（TCP）,该层通过发送（可能重发）、接收以及重排称为数据包（packet）的小
型网络信息，支持由字节流组成的双向网络会话。  
网际协议（IP），该层处理不同计算机间数据包的发送。  
最底层的"链路层",该层负责在直接相连的计算机之间发送物理信息，由网络硬件设备组成，
如以太网端口和无线网卡。  DSL调制解调器使用了频域多路复用  

### UDP：user datagram protocol  SOCK_DGRAM
#### 套接字
IP+port,实际就是fd
#### 连接
connect解决了客户端混杂（接收来自其他服务器的数据包）  但是并不绝对安全，服务器地址是可以被伪造的
#### 绑定
绑定本机外部IP时，服务器只能监听到发送到该IP的数据
绑定localhost时外部客户端不能访问到该服务器
#### 请求ID
请求ID是解决重复响应问题的重要利器。重复响应问题指的是，我们收到所有数据包后，又收到了一个被认为已经丢失的响应
#### 分组
小数据报更不易发生丢包  一般最大传输单元MTU是1500B
#### 广播-->多播
通过广播，可以将数据报的目标地址设置为本机连接的整个子网，然后使用物理网卡将数据报广播，这样就无需再复制该数据包并单独将其发送给所有连接至该子网的主机了。  
客户端广播：sock. setsockopt (socket.SOL_SOCKET, socket.SO_BROADCAST, 1)  
只有在每次只发送一条信息然后等待响应的时候， UDP才是高效的。--不如使用消息队列
再比如音视频通话不需要保证每个数据包都需要成功送达，也不需要重传

UDP建立在网络数据包的基础上，它是不可靠的。客户端需要弥补UDP的不可靠性，不断重发请求直至收
到响应为止。为了不使繁忙的网络情况变得更糟，客户端应该在重复传输失败时使用指数退避

IP地址：一般 .0子网名 .1连接网关 .255广播地址

多播：能够更好地利用网络及网络接口设备提供的许信息

地址族：
AF_INET:网络层
AF_UNIX：本机程序间通信

协议：http同时支持TCP UDP

### TCP/IP  SOCK_STREAM
每个数据包都有个序列号，接收程序根据序列号进行重组，如果有缺失就会要求重传，
初始序列号一般随机选择，后面的不是按照顺序编号，而是根据当前数据包的大小确定下一个数据包的序号（当前序列号+大小）
使用窗口进行流量控制

connect需要完成三次握手，而UDP的只是标明连接的服务端地址

数据流传输：TCP会对数据流进行分组，所以会有多个数据包到达接收端并进行重组，而UDP只有一个
由于发送、接收过程都可能会发生阻塞（缓冲区已满），需要都需要使用循环判断是否发送、接收完毕
发送可以使用sendall代替循环，但是接收需要自己判断

TCP bind后只是绑定了端口，lisen(num)才表明是服务器，产生监听套接字  每次accept后会产生新的连接套接字，负责与客户端进行通信

死锁？

#### TCP为什么建立连接是三次握手，而关闭连接却是四次挥手呢？

这是因为服务端在LISTEN状态下，收到建立连接请求的SYN报文后，把**ACK和SYN放在一个报文里发送给客户端**。而关闭连接时，
当收到对方的FIN报文时，仅仅表示**对方不再发送数据了但是还能接收数据**，己方也未必全部数据都发送给对方了，所以己方可以立即close，
也可以发送一些数据给对方后，再发送FIN报文给对方来表示同意现在关闭连接，因此，己方ACK和FIN一般都会分开发送。

![三次握手](https://github.com/yuanlongzeng/my-summary/blob/master/img/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.jpg)
